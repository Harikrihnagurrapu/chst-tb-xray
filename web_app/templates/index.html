<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TB X-ray Predictor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h1 class="mb-4">TB X-ray Predictor</h1>

      <form method="post" action="/predict" enctype="multipart/form-data">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="file" class="form-label">Upload chest X-ray image</label>
              <input class="form-control" type="file" id="file" name="file" accept="image/*" required>
            </div>

            <div class="mb-3">
              <label for="model" class="form-label">Model</label>
              <select id="model" name="model" class="form-select">
                <option value="EfficientNetB4" {{ 'selected' if models.get('EfficientNetB4') else '' }}>EfficientNetB4</option>
                <option value="ResNet50" {{ 'selected' if models.get('ResNet50') else '' }}>ResNet50</option>
                <option value="DenseNet121" {{ 'selected' if models.get('DenseNet121') else '' }}>DenseNet121</option>
              </select>
              <div class="form-text">You can optionally provide a custom model path below if you saved to a different location.</div>
            </div>

            <div class="mb-3">
              <label for="custom_model_path" class="form-label">Custom model path (optional)</label>
              <input type="text" class="form-control" id="custom_model_path" name="custom_model_path" placeholder="C:\\path\\to\\your\\model.keras">
            </div>

            <div class="mb-3">
              <label for="threshold" class="form-label">Decision threshold: <span id="threshold_val">{{ default_threshold }}</span></label>
              <input type="range" class="form-range" min="0" max="1" step="0.01" id="threshold" name="threshold" value="{{ default_threshold }}">
              <div class="form-text">Move the slider to change the threshold used to classify TB vs Normal.</div>
            </div>

            <button type="submit" class="btn btn-primary">Predict</button>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Preview</label>
              <div class="border p-2 bg-white" style="min-height:260px; display:flex; align-items:center; justify-content:center;">
                <img id="preview_img" src="#" alt="Preview" style="max-width:100%; max-height:380px; display:none;" />
                <span id="preview_placeholder" class="text-muted">No image selected</span>
              </div>
            </div>

            <div class="mt-3">
              <h6>Available model files</h6>
              <ul>
                <li>EfficientNetB4: {{ 'available' if models.get('EfficientNetB4') else 'missing' }}</li>
                <li>ResNet50: {{ 'available' if models.get('ResNet50') else 'missing' }}</li>
                <li>DenseNet121: {{ 'available' if models.get('DenseNet121') else 'missing' }}</li>
              </ul>
              <p class="text-muted small">API endpoint: <code>/api/predict</code> (POST). See README for usage.</p>
            </div>
          </div>
        </div>
      </form>

      <hr class="my-4">

      <p class="text-muted small">Tip: run this app locally with <code>python web_app/app.py</code> and then open <code>http://localhost:5000</code>.</p>
    </div>

    <script>
      // Image preview and threshold display
      const fileInput = document.getElementById('file');
      const previewImg = document.getElementById('preview_img');
      const previewPlaceholder = document.getElementById('preview_placeholder');
      const threshold = document.getElementById('threshold');
      const thresholdVal = document.getElementById('threshold_val');

      fileInput.addEventListener('change', (ev) => {
        const f = ev.target.files[0];
        if (!f) {
          previewImg.style.display = 'none';
          previewPlaceholder.style.display = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewImg.style.display = '';
          previewPlaceholder.style.display = 'none';
        };
        reader.readAsDataURL(f);
      });

      threshold.addEventListener('input', (ev) => {
        thresholdVal.innerText = ev.target.value;
      });
    </script>
  </body>
</html>