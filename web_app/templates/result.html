<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prediction Result</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h1 class="mb-4">Prediction Result</h1>
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">{{ label }}</h3>
              <p class="card-text">
                Probability of TB:
                <strong>{{ '%.3f'|format(probability) }}</strong>
              </p>
              <p class="card-text">
                <small class="text-muted">Model used: {{ model_name }}</small>
              </p>
              <a href="/" class="btn btn-secondary">Back</a>
              <a
                href="#"
                id="download_json"
                class="btn btn-outline-primary ms-2"
                >Download JSON</a
              >
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body text-center">
              {% if preview_b64 %}
              <img
                src="data:image/jpeg;base64,{{ preview_b64 }}"
                alt="Preview"
                style="max-width: 100%; max-height: 420px"
              />
              {% else %}
              <p class="text-muted">No preview available.</p>
              {% endif %}
              <p class="mt-3 small text-muted">
                Decision threshold used: {{ threshold }}
              </p>
              <p class="mt-2 small">
                <a href="/logs">View prediction log</a> (server-side)
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Prepare JSON for download using Jinja tojson
      const data = {{ {'label': label, 'probability': probability, 'model': model_name, 'threshold': threshold}|tojson }};
      const downloadBtn = document.getElementById('download_json');
      downloadBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prediction.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
